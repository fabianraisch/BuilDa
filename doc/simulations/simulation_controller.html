<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>src.simulations.simulation_controller API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>src.simulations.simulation_controller</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="src.simulations.simulation_controller.SimulationController"><code class="flex name class">
<span>class <span class="ident">SimulationController</span></span>
<span>(</span><span>worker_id: int,<br>config: <a title="src.utils.config.Config" href="../utils/config.html#src.utils.config.Config">Config</a>,<br>variation: <a title="src.variator.Variator" href="../variator.html#src.variator.Variator">Variator</a>)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class SimulationController:
    &#39;&#39;&#39;
    This class handles the simulation of the model in the FMU. It provides an interface to the external controllers 
    and manages the generated simulation output to be written after the simulation.
    &#39;&#39;&#39;
    def __init__(self, worker_id: int, config: Config, variation: Variator):
        self.id = worker_id
        self.config = config
        self.variation = variation

        self.fmu_wrapper = FMUWrapper(fmu_path=config.fmu_path, 
                                       start_time=config.get(&#34;start_time&#34;))
        

        self.step_size_arr = get_step_size_arr(config.get(&#34;start_time&#34;),
                                                config.get(&#34;stop_time&#34;),
                                                config.get(&#34;writer_step_size&#34;),
                                                config.get(&#34;controller_step_size&#34;),
                                                max_permitted_time_step=config.get_max_permitted_time_step())

        
        self.out_cols = [&#34;timestamp&#34;] + \
            list(set(self.fmu_wrapper.vrs.keys()).intersection(config.get(&#34;columns_included&#34;)))
        
        #%%initialization of FMU
        self.fmu_wrapper.fmu.enterInitializationMode()        
        self.converter = Converter(self.fmu_wrapper.fmu_default_dict, 
                            config.get(&#34;converter_functions&#34;))
        self.converted_variation = self.converter.convert(variation)
        self.fmu_wrapper.alter_in_fmu(param_dict=dict(self.converted_variation))
        self.fmu_wrapper.fmu.exitInitializationMode()
        self.fmu_wrapper.test_fmu_parameterizing(parameters=dict(self.converted_variation),
                                                 b_verbose_mode=False)
        
        self.controller_wrapper = ControllerWrapper(config.get(&#34;controller_name&#34;),
                                            config.get(&#34;controller_step_size&#34;),
                                            self.fmu_wrapper)

        self.controller_wrapper.configure_controllers()


    def generate_output_check(self, curr_time_relative):
        &#39;&#39;&#39;
        Determines if output should be generated at the current simulation time.
        Returns a boolean indicating whether output should be generated based on the elapsed simulation time and the `controller_step_size` parameter from the configuration.

        Parameters:
            curr_time_relative (float): The simulation time, elapsed since simulation start time

        Returns:
            bool: True if output should be generated, False otherwise.
        &#39;&#39;&#39;
        if curr_time_relative % self.config.get(&#34;writer_step_size&#34;) == 0:
            return True 
        else:
            return False

    def generate_output(self, curr_time, fmu_state_dict):
        &#39;&#39;&#39;
        Generates and returns a new result row for the current simulation time.

        This method creates a list containing the current time as an integer and appends values from the `fmu_state_dict` for each output column, skipping the timestamp header.

        Parameters:
            curr_time (float): The current simulation time.
            fmu_state_dict (dict): A dictionary containing the current state of the FMU variables.

        Returns:
            list: A list representing the result row for the current simulation time.
        &#39;&#39;&#39;    
        row = [int(curr_time)]
        for key in self.out_cols[1:]: # skip the timestamp header
            row.append(fmu_state_dict[key])
        return row

    def simulate_fmu(self):
        &#39;&#39;&#39;
        Executes one simulation of the model step by step, handling all model inputs and outputs during the simulation and returning the results.

        Returns:
            - rows (list): The generated output rows from the simulation.
            - out_cols (list): The output column headers.
            - converted_variation: The converted variation data.

        Parameters:
            None
        &#39;&#39;&#39;
        rows = []

        self.fmu_wrapper.save_current_fmu_variables(&#34;fmu_initial_state.csv&#34;)

        for step_size in self.step_size_arr:
            
            #calculate simulation time since simulation start time
            curr_time_relative=self.fmu_wrapper.time-self.config.get(&#34;start_time&#34;)
            b_perform_control = self.controller_wrapper.perform_control_check(curr_time_relative=
                                                                            curr_time_relative)
            
            b_generate_output = self.generate_output_check(curr_time_relative=curr_time_relative)

            variables_to_read = []
            if b_perform_control:
                variables_to_read += self.controller_wrapper.get_variables_to_read()

            if b_generate_output:
                variables_to_read += self.out_cols[1:]

            fmu_state_dict = self.fmu_wrapper.get_fmu_state_dict(variables_to_read=variables_to_read)

            if b_perform_control:
                self.controller_wrapper.handle_control_action(curr_time=self.fmu_wrapper.time, 
                                                              fmu_state_dict=fmu_state_dict)

            #read out again variables from fmu to get recent values influenced by controller (e.g. totalHeatingPower.y influenced by controller output ctrSignalHeating) (no doStep is necessary here) 
            fmu_state_dict = self.fmu_wrapper.get_fmu_state_dict(variables_to_read=variables_to_read)

            if b_generate_output:
                rows.append(self.generate_output(curr_time=self.fmu_wrapper.time, 
                                              fmu_state_dict=fmu_state_dict))

            self.fmu_wrapper.step_FMU(step_size=step_size)
            
        return rows, self.out_cols, self.converted_variation</code></pre>
</details>
<div class="desc"><p>This class handles the simulation of the model in the FMU. It provides an interface to the external controllers
and manages the generated simulation output to be written after the simulation.</p></div>
<h3>Methods</h3>
<dl>
<dt id="src.simulations.simulation_controller.SimulationController.generate_output"><code class="name flex">
<span>def <span class="ident">generate_output</span></span>(<span>self, curr_time, fmu_state_dict)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_output(self, curr_time, fmu_state_dict):
    &#39;&#39;&#39;
    Generates and returns a new result row for the current simulation time.

    This method creates a list containing the current time as an integer and appends values from the `fmu_state_dict` for each output column, skipping the timestamp header.

    Parameters:
        curr_time (float): The current simulation time.
        fmu_state_dict (dict): A dictionary containing the current state of the FMU variables.

    Returns:
        list: A list representing the result row for the current simulation time.
    &#39;&#39;&#39;    
    row = [int(curr_time)]
    for key in self.out_cols[1:]: # skip the timestamp header
        row.append(fmu_state_dict[key])
    return row</code></pre>
</details>
<div class="desc"><p>Generates and returns a new result row for the current simulation time.</p>
<p>This method creates a list containing the current time as an integer and appends values from the <code>fmu_state_dict</code> for each output column, skipping the timestamp header.</p>
<h2 id="parameters">Parameters</h2>
<p>curr_time (float): The current simulation time.
fmu_state_dict (dict): A dictionary containing the current state of the FMU variables.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code></dt>
<dd>A list representing the result row for the current simulation time.</dd>
</dl></div>
</dd>
<dt id="src.simulations.simulation_controller.SimulationController.generate_output_check"><code class="name flex">
<span>def <span class="ident">generate_output_check</span></span>(<span>self, curr_time_relative)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_output_check(self, curr_time_relative):
    &#39;&#39;&#39;
    Determines if output should be generated at the current simulation time.
    Returns a boolean indicating whether output should be generated based on the elapsed simulation time and the `controller_step_size` parameter from the configuration.

    Parameters:
        curr_time_relative (float): The simulation time, elapsed since simulation start time

    Returns:
        bool: True if output should be generated, False otherwise.
    &#39;&#39;&#39;
    if curr_time_relative % self.config.get(&#34;writer_step_size&#34;) == 0:
        return True 
    else:
        return False</code></pre>
</details>
<div class="desc"><p>Determines if output should be generated at the current simulation time.
Returns a boolean indicating whether output should be generated based on the elapsed simulation time and the <code>controller_step_size</code> parameter from the configuration.</p>
<h2 id="parameters">Parameters</h2>
<p>curr_time_relative (float): The simulation time, elapsed since simulation start time</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>bool</code></dt>
<dd>True if output should be generated, False otherwise.</dd>
</dl></div>
</dd>
<dt id="src.simulations.simulation_controller.SimulationController.simulate_fmu"><code class="name flex">
<span>def <span class="ident">simulate_fmu</span></span>(<span>self)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def simulate_fmu(self):
    &#39;&#39;&#39;
    Executes one simulation of the model step by step, handling all model inputs and outputs during the simulation and returning the results.

    Returns:
        - rows (list): The generated output rows from the simulation.
        - out_cols (list): The output column headers.
        - converted_variation: The converted variation data.

    Parameters:
        None
    &#39;&#39;&#39;
    rows = []

    self.fmu_wrapper.save_current_fmu_variables(&#34;fmu_initial_state.csv&#34;)

    for step_size in self.step_size_arr:
        
        #calculate simulation time since simulation start time
        curr_time_relative=self.fmu_wrapper.time-self.config.get(&#34;start_time&#34;)
        b_perform_control = self.controller_wrapper.perform_control_check(curr_time_relative=
                                                                        curr_time_relative)
        
        b_generate_output = self.generate_output_check(curr_time_relative=curr_time_relative)

        variables_to_read = []
        if b_perform_control:
            variables_to_read += self.controller_wrapper.get_variables_to_read()

        if b_generate_output:
            variables_to_read += self.out_cols[1:]

        fmu_state_dict = self.fmu_wrapper.get_fmu_state_dict(variables_to_read=variables_to_read)

        if b_perform_control:
            self.controller_wrapper.handle_control_action(curr_time=self.fmu_wrapper.time, 
                                                          fmu_state_dict=fmu_state_dict)

        #read out again variables from fmu to get recent values influenced by controller (e.g. totalHeatingPower.y influenced by controller output ctrSignalHeating) (no doStep is necessary here) 
        fmu_state_dict = self.fmu_wrapper.get_fmu_state_dict(variables_to_read=variables_to_read)

        if b_generate_output:
            rows.append(self.generate_output(curr_time=self.fmu_wrapper.time, 
                                          fmu_state_dict=fmu_state_dict))

        self.fmu_wrapper.step_FMU(step_size=step_size)
        
    return rows, self.out_cols, self.converted_variation</code></pre>
</details>
<div class="desc"><p>Executes one simulation of the model step by step, handling all model inputs and outputs during the simulation and returning the results.</p>
<h2 id="returns">Returns</h2>
<ul>
<li>rows (list): The generated output rows from the simulation.</li>
<li>out_cols (list): The output column headers.</li>
<li>converted_variation: The converted variation data.</li>
</ul>
<h2 id="parameters">Parameters</h2>
<p>None</p></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="src.simulations" href="index.html">src.simulations</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="src.simulations.simulation_controller.SimulationController" href="#src.simulations.simulation_controller.SimulationController">SimulationController</a></code></h4>
<ul class="">
<li><code><a title="src.simulations.simulation_controller.SimulationController.generate_output" href="#src.simulations.simulation_controller.SimulationController.generate_output">generate_output</a></code></li>
<li><code><a title="src.simulations.simulation_controller.SimulationController.generate_output_check" href="#src.simulations.simulation_controller.SimulationController.generate_output_check">generate_output_check</a></code></li>
<li><code><a title="src.simulations.simulation_controller.SimulationController.simulate_fmu" href="#src.simulations.simulation_controller.SimulationController.simulate_fmu">simulate_fmu</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
